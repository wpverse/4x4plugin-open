jQuery(document).ready(function(){function e(){gridQuadHeight=.35*w.getBoundingClientRect().width,extraAreasHeight=.2*w.getBoundingClientRect().width,L.style.height=extraAreasHeight+"px",F.style.height=gridQuadHeight+"px",D.style.height=gridQuadHeight+"px",N.style.height=gridQuadHeight+"px",P.style.height=gridQuadHeight+"px",H.style.height=extraAreasHeight+"px"}function t(){if(userId){var e=document.getElementById("matrix-container");interact(".draggable").draggable({inertia:!0,restrict:{restriction:e,endOnly:!0,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!0,onmove:o,onend:function(e){console.log(e.target.dataset.postid),n(e.target.dataset.postid,e.target.dataset.xpos,e.target.dataset.ypos)}})}else;}function o(e){var t=e.target,o=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,r=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.webkitTransform=t.style.transform="translate("+o+"px, "+r+"px)",t.setAttribute("data-x",o),t.setAttribute("data-y",r);var a=jQuery("#matrix-container").height(),n=jQuery("#matrix-container").width();console.log("x: "+o+" y: "+r),console.log("gridH: "+a+" gridW: "+n);var l=o/n*100,d=r/a*100;t.setAttribute("data-xpos",l),t.setAttribute("data-ypos",d),i(e.target)}function r(){console.log("Click.. :remove ACTIVE"),jQuery(".drag-todo").removeClass("active"),jQuery(".drag-todo .remove").removeClass("removal"),i(),v()}function a(){return j(null,"doing save UpdateFormContents()"),(U=document.getElementById(I))?l().then(function(e){return 0==e&&(j(null,"level 2 fail"),console.log(e)),e}):(j(null,"ajaxUpdateContent failed. No currently selected item"),!1)}function n(e,t,o){console.log("ajaxUpdatePosition(postId,xpos,ypos)");var r={action:"pm_update_position",user_id:userId,post_id:e,xpos:t,ypos:o},a=ajax_url+"pm_update_position";jQuery.post(a,r,function(t){var o=jQuery(t).find("data").text(),r=jQuery(t).find("status").text();if(console.log("reply"),console.log(o),console.log("status"),console.log(r),r){console.log("inner- position updated"),jQuery("#post-updated").stop().fadeIn(300).fadeOut(1e3);var a="#drag-"+e+" .update-border";return jQuery(a).fadeIn(100).fadeOut(600),!0}return console.log("inner- position update failed!"),j("Couldn't save position to server","ajax position server update failed!"),!1})}function l(){if(j(null,"doing ajax Update Content()"),!userId)return j(null,"Not saving. User not logged-in"),!1;U=document.getElementById(I);var e=U.dataset.postid,t="drag-"+jQuery("#post_id").val(),o=jQuery("#edit-todo-title").val(),r=jQuery("select#todo-label").val();jQuery("#"+I+" .pm-todo-label").removeClass("unlabeled filter-one filter-two filter-three"),jQuery("#"+I+" .pm-todo-label").addClass(r).data("label",r),jQuery("#"+I).removeClass("unlabeled filter-one filter-two filter-three"),jQuery("#"+I).addClass(r),jQuery("#"+I+" .todo-title").html(o),j(null,"starting ajax content update");var a={action:"pm_update_todo",post_id:e,user_id:userId,title:o,pm_filter:r},n=ajax_url+"pm_update_todo";return jQuery.post(n,a,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();return console.log("All:"),console.log(o),o?(j(null,"server response ajax Update Content() true"),C=!1,o):(j(null,"server response ajax Update Content() false"),o)}).then(function(e){return jQuery(e).find("status").text()})}function d(){if(j(null,"doing ajax New Todo()"),!userId)return void j(null,"Not saving. User not logged-in");var e=jQuery("#new-todo-title").val(),t=jQuery("select#new-todo-label").val();console.log("starting ajax new todo");var o={action:"pm_new_todo",user_id:userId,title:e,pm_filter:t},r=ajax_url+"pm_new_todo",a=jQuery.post(r,o,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();if(console.log("All:"),console.log(e),console.log("reply"),console.log(t),console.log("status"),console.log(o),o){console.log("New Todo Created!");var r=jQuery("#new-todo-title").val(),a=jQuery("select#new-todo-label").val(),n=jQuery("#matrix-container").height(),l=jQuery("#matrix-container").width(),d=l/2,i=n/2,s='<div id="drag-'+o+'" class="draggable drag-todo js-drag pm-activity dropzone yes-drop" data-postid="'+o+'" data-xpos="50" data-ypos="50" data-x="'+d+'" data-y="'+i+'" style="transform: translate('+d+"px, "+i+'px);"><div class="pm-todo-label '+a+'" data-label="'+a+'"></div><div class="inner-border"><div class="todo-title">'+r+'</div></div></div><div class="update-border"><div class="status-border"></div></div>';return jQuery("#todo-set").append(s),A=!1,o}return console.log("New todo Ajax failed!"),!1})}function i(e){if(e&&(e.id!==I?console.log("++they are not equal++"):console.log("++they are equal++")),e){if("changed"==C){var t=a();return t.then(function(t){return console.log("return checkSaved then result:"),console.log(t),0==t?(j(null,"Failed to save edit update to server"),!1):(I=e.id,jQuery(".drag-todo").removeClass("active"),jQuery("#"+I).addClass("active"),s(I),_(),!0);return t})}return console.log("setting active"),I=e.id,jQuery(".remove").removeClass("removal"),jQuery(".drag-todo").removeClass("active"),jQuery("#"+I).addClass("active"),s(I),_(),!0}if(j(null,"updateWhatsCurrentlyActive deselecting all"),"changed"==C){j(null,"trying to save changed form before deselecting all");var t=a();return t.then(function(e){return console.log("return checkSaved then result:"),console.log(e),0==e?j(null,"Failed to save edit update to server"):(I=0,s(I)),e})}return I=0,jQuery(".drag-todo").removeClass("active"),s(I),"no need";return result}function s(e){if(console.log("loadEditor("+e+")"),e){console.log("id has post"),console.log(jQuery("#post_id").val()),console.log(e);if("drag-"+jQuery("#post_id").val()!==e){var t=jQuery("#"+e+" .todo-title").html(),o=jQuery("#"+e+" .pm-todo-label").data("label"),r=jQuery("#"+e).data("postid");console.log(t),jQuery("#edit-todo-title").val(t),jQuery("select#todo-label").val(o),jQuery("#post_id").val(r),jQuery("#matrix-tabs a:last").tab("show"),y(),x()}else console.log("already loaded")}else console.log("id is empty or false"),p()}function u(){if(console.log("ajaxUpdateFilters()"),!userId)return console.log("Not saving. User not logged-in"),!1;var e="drag-"+jQuery("#post_id").val(),t=jQuery("#edit-todo-title").val(),o=jQuery("select#todo-label").val(),r=$jQuery("#filter-one").data("color"),a=$jQuery("#filter-one-label").data("label"),n=$jQuery("#filter-two").data("color"),l=$jQuery("#filter-two-label").data("label"),d=$jQuery("#filter-three").data("color"),i=$jQuery("#filter-one-three").data("label");console.log("postId:"+e),console.log("wpPostId:"+wpPostId),console.log("starting ajax content update");var s={action:"pm_update_filters",npm_filter_one_label:r,npm_filter_one_color:a,npm_filter_two_label:n,npm_filter_one_color:a,npm_filter_two_label:n,npm_filter_one_color:a,npm_active_filter:npmActiveFilter},u=ajax_url+"pm_update_filters";jQuery.post(u,s,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();return console.log("All:"),console.log(e),o?(console.log("ajaxUpdateFilter Content updated!"),B=!1,!0):(B=!0,j(null,"server ajaxUpdateFilters() returned false"),!1)})}function c(e){var t=(new Date).getTime();console.log("trying filter:"+e),"filter-none"==e?jQuery(".drag-todo").removeClass("hidden"):(jQuery(".drag-todo").addClass("hidden"),jQuery("."+e).removeClass("hidden"));var o=(new Date).getTime()-t;console.log("Time to filter:"+o)}function g(){jQuery("#todo-new")[0].reset()}function p(){console.log("clearing form"),jQuery("#todo-edit")[0].reset(),jQuery("#post_id").val("")}function y(){for(var e=document.getElementById("todo-edit"),t=e.elements,o=0,r=t.length;o<r;++o)jQuery(t[o]).attr("disabled",!1)}function v(){for(var e=document.getElementById("todo-edit"),t=e.elements,o=0,r=t.length;o<r;++o)jQuery(t[o]).attr("disabled",!0)}function f(){for(var e=document.getElementById("todo-new"),t=e.elements,o=0,r=t.length;o<r;++o)jQuery(t[o]).attr("disabled",!1)}function m(){for(var e=document.getElementById("todo-new"),t=e.elements,o=0,r=t.length;o<r;++o)jQuery(t[o]).attr("disabled",!0)}function j(e,t){e&&(console.log("msg"+e),jQuery("#pm-error-notice").finish(),jQuery("#pm-error-notice").text(e).slideDown("slow").delay(3e3).slideUp("slow")),t&&console.log("displayNotice:"+t)}function Q(){var t;jQuery(window).on("resize",function(o){clearTimeout(t),e(),t=setTimeout(function(){h()},250)})}function h(){console.log("repositionAllFromSavedPercentage()");var e=jQuery("#matrix-container").height(),t=jQuery("#matrix-container").width(),o="",o=jQuery(".drag-todo"),r="",a="";jQuery(".drag-todo").each(function(o){var r=document.getElementById(jQuery(this).attr("id")),a=r.dataset.xpos,n=r.dataset.ypos;if(a)var l=t*a/100;else var l=.1;if(n)var d=e*n/100;else var d=.1;r.setAttribute("data-x",l),r.setAttribute("data-y",d),r.style.webkitTransform="translate("+l+"px, "+d+"px)",r.style.transform="translate("+l+"px, "+d+"px)"})}function x(){C=!1,jQuery(".todo-edit-input").each(function(){var e=jQuery(this);e.data("oldVal",e.val()),e.bind("propertychange change click keyup input paste",function(t){e.data("oldVal")!=e.val()&&(e.data("oldVal",e.val()),C="changed")})})}function _(){console.log("setupTodoListeners"),jQuery(".remove-todo-open").unbind(),jQuery(".remove").unbind(),jQuery(".drag-todo.active .remove-todo-open").click(function(e){e.stopPropagation(),console.log("clicked X set"),jQuery(".drag-todo.active .remove").addClass("removal")}),jQuery(".drag-todo.active .remove").click(function(e){return e.stopPropagation(),b(jQuery(this).parent().parent().data("postid")).then(function(e){return console.log("test result "+e+": "+e),rTargetId="#"+I,console.log("activeTodo: "+rTargetId),jQuery(rTargetId).remove(),e});console.log(this),console.log("clicked R set");var t=b();alert("clicked B")})}function b(e){if(console.log("ajaxSendToDraft()"),!userId)return console.log("Not saving. User not logged-in"),!1;e!==I&&(console.log("draftId"+e),console.log("activeTodo"+I)),U=document.getElementById(I);var t=U.dataset.postid,o={action:"pm_set_as_draft",post_id:t,user_id:userId},r=ajax_url+"pm_set_as_draft";return jQuery.post(r,o,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();return console.log("All:"),console.log(e),"setAsDraft"==o?(console.log("ajaxSetAsDraft set to draft!"),B=!1,o):(B=!0,j(null,"server ajaxSetAsDraft() returned false"),!1)}).then(function(e){return jQuery(e).find("status").text()})}var w=document.getElementById("matrix-container");if(w){console.log("Main.js Loaded");var I="",C="",k="",A="",T="",B="",E="",U="",L=document.getElementById("todo-backlog-area"),F=document.getElementById("urgent-important"),D=document.getElementById("not-urgent-important"),N=document.getElementById("urgent-not-important"),P=document.getElementById("not-urgent-not-important"),H=document.getElementById("todo-done-area");userId=jQuery("#matrix-container").data("userid"),0==userId||null==userId?j("You are not Logged-in. Please login to make changes.","User not logged-in"):(j(null,"makeBoardDraggable()"),t(),j(null,"trying to unlock edit form"),y(),f()),e(),Q(),h(),window.dragMoveListener=o,jQuery(".grid-quad").click(function(){r()}),jQuery(".drag-todo").click(function(){if(0==userId||null==userId)return void j("You are not Logged-in. Please login to make changes.","User not logged-in");console.log(this);var e=i(this);console.log(e)}),jQuery("#edit_pm_submit").click(function(e){e.preventDefault(),e.stopPropagation(),a()?(r(),p()):j("saveUpdateFormContents() failed. Keeping current selection","error returned from saveUpdateFormContents()")}),jQuery("#pm-form-edit-todo-panel input, #pm-form-edit-todo-panel select").on("input",function(){console.log("edit form change"),C="changed"}),jQuery("#new_pm_submit").click(function(e){e.preventDefault(),e.stopPropagation(),jQuery("#new-todo-title").val()||jQuery("#new-todo-title").addClass("alert-danger").delay("200").removeClass("alert-danger"),console.log("trying ajaxNewTodo()"),d()?(r(),g()):(E++,console.log(E))});var S=jQuery(".pm-activity");interact(".dropzone").dropzone({accept:".yes-drop",overlap:.75,ondropactivate:function(e){e.target.classList.add("drop-active")},ondragenter:function(e){var t=e.relatedTarget;e.target.classList.add("drop-target"),t.classList.add("can-drop")},ondragleave:function(e){e.target.classList.remove("drop-target"),e.relatedTarget.classList.remove("can-drop")},ondrop:function(e){e.relatedTarget.classList.add("dropped"),console.log("remove dropped item and make it a subtask of drop-target")},ondropdeactivate:function(e){e.target.classList.remove("drop-active"),e.target.classList.remove("drop-target")}}),jQuery(".matrix-filter").click(function(e){var t=jQuery(this).data("filter");jQuery(".matrix-filter").removeClass("active"),jQuery(this).addClass("active"),console.log(t),c(t)})}});