jQuery(document).ready(function(){function e(){gridQuadHeight=.35*b.getBoundingClientRect().width,extraAreasHeight=.2*b.getBoundingClientRect().width,B.style.height=extraAreasHeight+"px",U.style.height=gridQuadHeight+"px",T.style.height=gridQuadHeight+"px",F.style.height=gridQuadHeight+"px",L.style.height=gridQuadHeight+"px",N.style.height=extraAreasHeight+"px"}function t(){if(userId){var e=document.getElementById("matrix-container");interact(".draggable").draggable({inertia:!0,restrict:{restriction:e,endOnly:!0,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!0,onmove:o,onend:function(e){console.log(e.target.dataset.postid),n(e.target.dataset.postid,e.target.dataset.xpos,e.target.dataset.ypos)}})}else;}function o(e){var t=e.target,o=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,a=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.webkitTransform=t.style.transform="translate("+o+"px, "+a+"px)",t.setAttribute("data-x",o),t.setAttribute("data-y",a);var r=jQuery("#matrix-container").height(),n=jQuery("#matrix-container").width();console.log("x: "+o+" y: "+a),console.log("gridH: "+r+" gridW: "+n);var l=o/n*100,d=a/r*100;t.setAttribute("data-xpos",l),t.setAttribute("data-ypos",d),i(e.target)}function a(){console.log("Click.. :remove ACTIVE"),jQuery(".drag-todo").removeClass("active"),i(),m()}function r(){return j(null,"doing save UpdateFormContents()"),todoElement=document.getElementById(_),todoElement?l().then(function(e){return 0==e&&(j(null,"level 2 fail"),console.log(e)),e}):(j(null,"ajaxUpdateContent failed. No currently selected item"),!1)}function n(e,t,o){console.log("updatePosition(postId,xpos,ypos)");var a={action:"pm_update_position",user_id:userId,post_id:e,xpos:t,ypos:o};jQuery.post(ajax_url,a,function(t){var o=jQuery(t).find("data").text(),a=jQuery(t).find("status").text();if(console.log("reply"),console.log(o),console.log("status"),console.log(a),a){console.log("inner- position updated"),jQuery("#post-updated").stop().fadeIn(300).fadeOut(1e3);var r="#drag-"+e+" .update-border";return jQuery(r).fadeIn(100).fadeOut(600),!0}return console.log("inner- position update failed!"),j("Couldn't save position to server","ajax position server update failed!"),!1})}function l(){if(j(null,"doing ajax Update Content()"),!userId)return console.log("Not saving. User not logged-in"),!1;var e=todoElement.dataset.postid,t="drag-"+jQuery("#post_id").val(),o=jQuery("#edit-todo-title").val(),a=jQuery("select#todo-label").val();jQuery("#"+_+" .pm-todo-label").removeClass("unlabeled red orange green"),jQuery("#"+_+" .pm-todo-label").addClass(a).data("label",a),jQuery("#"+_).removeClass("unlabeled filter-one filter-two filter-three"),jQuery("#"+_).addClass(a),jQuery("#"+_+" .todo-title").html(o),j(null,"starting ajax content update");var r={action:"pm_update_todo",post_id:e,user_id:userId,title:o,pm_filter:a};return jQuery.post(ajax_url,r,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();return console.log("All:"),console.log(o),o?(j(null,"server response ajax Update Content() true"),w=!1,o):(j(null,"server response ajax Update Content() false"),o)}).then(function(e){return jQuery(e).find("status").text()})}function d(){if(console.log("ajaxNewTodo()"),!userId)return void j("Not saving. User not logged-in");var e=jQuery("#new-todo-title").val(),t=jQuery("select#new-todo-label").val();console.log("starting ajax new todo");var o={action:"pm_new_todo",user_id:userId,title:e,pm_filter:t};jQuery.post(ajax_url,o,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();if(console.log("All:"),console.log(e),console.log("reply"),console.log(t),console.log("status"),console.log(o),o){console.log("New Todo Created!");var a=jQuery("#new-todo-title").val(),r=jQuery("select#new-todo-label").val(),n=jQuery("#matrix-container").height(),l=jQuery("#matrix-container").width(),d=l/2,i=n/2,s='<div id="drag-'+o+'" class="draggable drag-todo js-drag pm-activity dropzone yes-drop" data-postid="'+o+'" data-xpos="50" data-ypos="50" data-x="'+d+'" data-y="'+i+'" style="transform: translate('+d+"px, "+i+'px);"><div class="pm-todo-label '+r+'" data-label="'+r+'"></div><div class="inner-border"><div class="todo-title">'+a+'</div></div></div><div class="update-border"><div class="status-border"></div></div>';return jQuery("#todo-set").append(s),C=!1,o}return console.log("New todo Ajax failed!"),!1})}function i(e){if(jQuery(".drag-todo").removeClass("active"),e){if("changed"==w){var t=r();return t.then(function(t){return console.log("return checkSaved then result:"),console.log(t),0==t?(j(null,"Failed to save edit update to server"),!1):(_=e.id,e.className+=" active",s(_),!0);return t})}_=e.id,e.className+=" active",s(_)}else{if(j(null,"updateWhatsCurrentlyActive deselecting all"),"changed"==w){j(null,"trying to save changed form before deselecting all");var t=r();return t.then(function(e){return console.log("return checkSaved then result:"),console.log(e),0==e?j(null,"Failed to save edit update to server"):(_=0,s(_)),e})}_=0,s(_)}}function s(e){if(console.log("loadEditor("+e+")"),e){console.log("id has post");var t=jQuery("#"+e+" .todo-title").html(),o=jQuery("#"+e+" .pm-todo-label").data("label"),a=jQuery("#"+e).data("postid");console.log(t),jQuery("#edit-todo-title").val(t),jQuery("select#todo-label").val(o),jQuery("#post_id").val(a),jQuery("#matrix-tabs a:last").tab("show"),y(),x()}else console.log("id is empty or false"),document.getElementById("todo-edit").reset()}function u(){if(console.log("ajaxUpdateFilters()"),!userId)return console.log("Not saving. User not logged-in"),!1;var e="drag-"+jQuery("#post_id").val(),t=jQuery("#edit-todo-title").val(),o=jQuery("select#todo-label").val(),a=$jQuery("#filter-one").data("color"),r=$jQuery("#filter-one-label").data("label"),n=$jQuery("#filter-two").data("color"),l=$jQuery("#filter-two-label").data("label"),d=$jQuery("#filter-three").data("color"),i=$jQuery("#filter-one-three").data("label");console.log("postId:"+e),console.log("wpPostId:"+wpPostId),console.log("starting ajax content update");var s={action:"pm_update_filters",npm_filter_one_label:a,npm_filter_one_color:r,npm_filter_two_label:n,npm_filter_one_color:r,npm_filter_two_label:n,npm_filter_one_color:r,npm_active_filter:npmActiveFilter};jQuery.post(ajax_url,s,function(e){var t=jQuery(e).find("data").text(),o=jQuery(e).find("status").text();return console.log("All:"),console.log(e),o?(console.log("ajaxUpdateFilter Content updated!"),k=!1,!0):(k=!0,j(null,"server ajaxUpdateFilters() returned false"),!1)})}function c(e){var t=(new Date).getTime();console.log("trying filter:"+e),"filter-none"==e?jQuery(".drag-todo").removeClass("hidden"):(jQuery(".drag-todo").addClass("hidden"),jQuery("."+e).removeClass("hidden"));var o=(new Date).getTime()-t;console.log("Time to filter:"+o)}function g(){jQuery("#todo-new")[0].reset()}function p(){jQuery("#todo-edit")[0].reset()}function y(){for(var e=document.getElementById("todo-edit"),t=e.elements,o=0,a=t.length;o<a;++o)jQuery(t[o]).attr("disabled",!1)}function m(){for(var e=document.getElementById("todo-edit"),t=e.elements,o=0,a=t.length;o<a;++o)jQuery(t[o]).attr("disabled",!0)}function f(){for(var e=document.getElementById("todo-new"),t=e.elements,o=0,a=t.length;o<a;++o)jQuery(t[o]).attr("disabled",!1)}function v(){for(var e=document.getElementById("todo-new"),t=e.elements,o=0,a=t.length;o<a;++o)jQuery(t[o]).attr("disabled",!0)}function j(e,t){e&&(console.log("msg"+e),jQuery("#pm-error-notice").finish(),jQuery("#pm-error-notice").text(e).slideDown("slow").delay(3e3).slideUp("slow")),t&&console.log("displayNotice:"+t)}function Q(){var t;jQuery(window).on("resize",function(o){clearTimeout(t),e(),t=setTimeout(function(){h()},250)})}function h(){console.log("repositionAllFromSavedPercentage()");var e=jQuery("#matrix-container").height(),t=jQuery("#matrix-container").width(),o="",o=jQuery(".drag-todo"),a="",r="";jQuery(".drag-todo").each(function(o){var a=document.getElementById(jQuery(this).attr("id")),r=a.dataset.xpos,n=a.dataset.ypos;if(r)var l=t*r/100;else var l=.1;if(n)var d=e*n/100;else var d=.1;a.setAttribute("data-x",l),a.setAttribute("data-y",d),a.style.webkitTransform="translate("+l+"px, "+d+"px)",a.style.transform="translate("+l+"px, "+d+"px)"})}function x(){w=!1,jQuery(".todo-edit-input").each(function(){var e=jQuery(this);e.data("oldVal",e.val()),e.bind("propertychange change click keyup input paste",function(t){e.data("oldVal")!=e.val()&&(e.data("oldVal",e.val()),w="changed")})})}var b=document.getElementById("matrix-container");if(b){console.log("Main.js Loaded");var _="",w="",I="",C="",E="",k="",A="",B=document.getElementById("todo-backlog-area"),U=document.getElementById("urgent-important"),T=document.getElementById("not-urgent-important"),F=document.getElementById("urgent-not-important"),L=document.getElementById("not-urgent-not-important"),N=document.getElementById("todo-done-area");userId=jQuery("#matrix-container").data("userid"),0==userId||null==userId?j("You are not Logged-in. Please login to make changes.","User not logged-in"):(j(null,"makeBoardDraggable()"),t(),j(null,"trying to unlock edit form"),y(),f()),e(),Q(),h(),window.dragMoveListener=o,jQuery(".grid-quad").click(function(){a()}),jQuery(".drag-todo").click(function(){if(0==userId||null==userId)return void j("You are not Logged-in. Please login to make changes.","User not logged-in");i(this)}),jQuery("#edit_pm_submit").click(function(e){e.preventDefault(),e.stopPropagation(),r()?(a(),p()):j("saveUpdateFormContents() failed. Keeping current selection","error returned from saveUpdateFormContents()")}),jQuery("#pm-form-edit-todo-panel input, #pm-form-edit-todo-panel select").on("input",function(){console.log("edit form change"),w="changed"}),jQuery("#new_pm_submit").click(function(e){e.preventDefault(),e.stopPropagation(),jQuery("#new-todo-title").val()||jQuery("#new-todo-title").addClass("alert-danger").delay("200").removeClass("alert-danger"),console.log("trying ajaxNewTodo()"),d()?(a(),g()):(A++,console.log(A))});var H=jQuery(".pm-activity");interact(".dropzone").dropzone({accept:".yes-drop",overlap:.75,ondropactivate:function(e){e.target.classList.add("drop-active")},ondragenter:function(e){var t=e.relatedTarget;e.target.classList.add("drop-target"),t.classList.add("can-drop")},ondragleave:function(e){e.target.classList.remove("drop-target"),e.relatedTarget.classList.remove("can-drop")},ondrop:function(e){e.relatedTarget.classList.add("dropped"),console.log("remove dropped item and make it a subtask of drop-target")},ondropdeactivate:function(e){e.target.classList.remove("drop-active"),e.target.classList.remove("drop-target")}}),jQuery(".matrix-filter").click(function(e){var t=jQuery(this).data("filter");jQuery(".matrix-filter").removeClass("active"),jQuery(this).addClass("active"),console.log(t),c(t)})}});